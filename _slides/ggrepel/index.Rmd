---
title: "ggrepel"
subtitle: ""
author: "Kamil Slowikowski @slowkow"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    chakra: libs/remark-latest.min.js
    css: "theme.css"
    #css: [default, metropolis, metropolis-fonts]
    lib_dir: libs
    nature:
      navigation:
        click: false
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    seal: false
    includes:
      in_header: header.html
    #mathjax: null
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(dplyr)
library(gridExtra)
library(ggplot2)
library(ggrepel)
library(scales)
library(sitools)
library(knitr)
opts_chunk$set(
  pngquant    = "--speed=1 --quality=0-10"
)
knit_hooks$set(
  pngquant = hook_pngquant
)
theme_set(theme_classic(base_size = 18) %+replace% theme(
  # axis.line.y = element_line(colour = "black", size = 0.2),
  # axis.line.x = element_line(colour = "black", size = 0.2),
  axis.ticks   = element_line(colour = "black", size = 0.3),
  panel.border = element_rect(size = 0.3, fill = NA),
  axis.line    = element_blank(),
  plot.title   = element_text(size = 18, vjust = 2, hjust = 0.5)
))
```

class: title-slide-custom, center

# Introduction to **ggrepel**

.larger[
July 2018

<img src="index_files/logo.svg" width="120px"></img>

[github.com/slowkow/ggrepel](https://github.com/slowkow/ggrepel)

<a class="github-button" href="https://github.com/slowkow/ggrepel" data-size="large" data-show-count="true" aria-label="Star slowkow/ggrepel on GitHub">Star</a>

Kamil Slowikowski <br> [@slowkow](https://twitter.com/slowkow)
]

---

# &#x1F61E; **Problem:** text placement

.pull-left[
<br>
```{r tidy=FALSE, eval=FALSE}
library(ggplot2)

ggplot(mtcars) + 
  aes(
    x = wt, y = mpg,
    label = rownames(mtcars)
  ) + 
  geom_point(color = "red") +
  geom_text() #<<
```
]

.pull-right[
```{r problem, echo=FALSE, fig.height=4, fig.width=4, dpi=200}
set.seed(42)

dat <- subset(mtcars, wt > 2.75 & wt < 3.45)
dat$car <- rownames(dat)

p <- ggplot(dat, aes(wt, mpg, label = car)) +
  geom_point(color = "red")

p1 <- p + geom_text() + labs(title = "geom_text()")

p1
```
]

---

# &#x1F389; **Solution:** ggrepel

.pull-left[
<br>
```{r tidy=FALSE, eval=FALSE}
library(ggrepel)

ggplot(mtcars) + 
  aes(
    x = wt, y = mpg,
    label = rownames(mtcars)
  ) + 
  geom_point(color = "red") +
  geom_text_repel() #<<
```
]

.pull-right[
```{r solution, echo=FALSE, fig.height=4, fig.width=4, dpi=200}
set.seed(42)

dat <- subset(mtcars, wt > 2.75 & wt < 3.45)
dat$car <- rownames(dat)

p <- ggplot(dat, aes(wt, mpg, label = car)) +
  geom_point(color = "red")

p2 <- p + geom_text_repel() + labs(title = "geom_text_repel()")

p2
```
]

---

# &#x1F60A; Much better!

```{r ex1, echo=FALSE, fig.height=4, fig.width=8, dpi=200}
set.seed(42)

dat <- subset(mtcars, wt > 2.75 & wt < 3.45)
dat$car <- rownames(dat)

p <- ggplot(dat, aes(wt, mpg, label = car)) +
  geom_point(color = "red")

p1 <- p + geom_text() + labs(title = "geom_text()")

p2 <- p + geom_text_repel() + labs(title = "geom_text_repel()")

gridExtra::grid.arrange(p1, p2, ncol = 2)
```

---

# **Repel** text labels away from

.pull-left-large[
<br>
- other text labels

- data points

- edges of the plotting area
]

.pull-right[
```{r ex2, echo=FALSE, fig.height=4, fig.width=4, dpi=200}
set.seed(42)

dat <- subset(mtcars, wt > 2.75 & wt < 3.45)
dat$car <- rownames(dat)

p2 <- p + geom_text_repel() + labs(title = "geom_text_repel()")

p2
```
]

---

# &#x1F4DC; Algorithm

.large[
$O(n^2)$ N-body physical simulation
]

```{r algorithm, echo=FALSE, fig.height=2.5, fig.width=4.5, dpi=300}
d <- data.frame(x = c(1, 2), y = c(1,1))
d_t <- data.frame(
  x = c(1.35, 1.64),
  y = c(1.2, 1.22),
  z = c("Text1", "Text2")
)
d_s <- d_t
d_s$y <- d_s$y + 0.1
d_s <- cbind(d_s[1, 1:2], d_s[2,1:2])
colnames(d_s) <- c("x", "y", "xend", "yend")
d_s2 <- cbind(d, d_t)
colnames(d_s2) <- c("x", "y", "xend", "yend", "z")
d_s3 <- d_s2
d_s3[1,c("x", "xend")] <- d_s3[1,c("x", "xend")] + 0.07
d_s3[2,c("x", "xend")] <- d_s3[2,c("x", "xend")] - 0.07
d_s3[1,c("y", "yend")] <- d_s3[1,c("y", "yend")] - 0.07
d_s3[2,c("y", "yend")] <- d_s3[2,c("y", "yend")] - 0.07
ggplot() +
  geom_segment(
    data = d_s2,
    mapping = aes(x, y, xend = xend, yend = yend),
    size = 1
  ) +
  geom_point(
    data = d,
    mapping = aes(x, y),
    size = 5
  ) +
  geom_label(
    data = d_t,
    mapping = aes(x, y, label = z),
    size = 10,
    alpha = 0.5
  ) +
  geom_segment(
    data = d_s,
    mapping = aes(x, y, xend = xend, yend = yend),
    arrow = arrow(ends = "both"),
    color = "red",
    size = 2
  ) +
  geom_segment(
    data = d_s3,
    mapping = aes(x, y, xend = xend, yend = yend),
    size = 2,
    color = "blue",
    arrow = arrow(ends = "first")
  ) +
  annotate(
    geom = "text",
    x = 1.5,
    y = 1.42,
    label = "Repel!",
    color = "red",
    angle = 7,
    size = 10
  ) +
  annotate(
    geom = "text",
    x = 1.5,
    y = 1.0,
    label = "Attract!",
    color = "blue",
    angle = -7,
    size = 10
  ) +
  scale_x_continuous(limits = c(0.9, 2.1)) +
  scale_y_continuous(limits = c(0.85, 1.5)) +
  labs(x = NULL, y = NULL) +
  theme(axis.ticks = element_blank(),
        axis.text = element_blank())
```

---

# &#x1F40E; **ggrepel** in action

<video src="index_files/animation.mp4" type="video/mp4" style="height:75%; margin-left:8%;" muted autoplay loop></video>

---

# &#x1F4BE; Installation

.pull-left-large[
Install **ggrepel** from [CRAN](https://CRAN.R-project.org/package=ggrepel):

```{r eval=FALSE, tidy=FALSE}
install.packages("ggrepel")
```

]

.pull-right[
```{r downloads, echo=FALSE, fig.height=2, fig.width=3, dpi=300}
downloads <- cranlogs::cran_downloads(
  packages = "ggrepel",
  from = "2016-01-09",
  to = Sys.Date()
)
downloads$date <- as.Date(downloads$date)
downloads$count_sum <- cumsum(downloads$count)
ggplot(downloads, aes(date, count_sum)) +
  stat_smooth(method = "loess") +
  scale_y_continuous(
    labels = scales::comma_format(),
    breaks = c(0, round(max(downloads$count_sum) / 1e3) * 1e3)
  ) +
  geom_label_repel(
    data = data.frame(
      date = as.Date("2016-01-09"),
      count_sum = 2e4,
      label = "ggrepel\nwas created"
    ),
    mapping = aes(date, count_sum, label = label),
    nudge_y = 4e5,
    arrow = arrow(type = "open", length = unit(0.5, "lines"), )
  ) +
  labs(x = NULL, y = NULL, title = "Downloads")
```
]

---

# &#x1F92D; Don't label too many points!

.large[
Or else you will end up with [@accidental__aRt]
]

<div class="center">
<img src="index_files/accidental-art-1.png" alt="" style="width: 66%;">
</div>

[@accidental__aRt]: https://twitter.com/accidental__aRt

---

# &#x1F4A1; Use the empty string ""

.pull-left[
```{r tidy=FALSE, eval=FALSE}
library(ggrepel)
d <- subset(
  mtcars, wt > 3 & wt < 4
)
# Just label 3 items.
d$car <- "" #<<
i <- c(2, 3, 16) #<<
d$car[i] <- rownames(d)[i] #<<

ggplot(d) +
  aes(wt, mpg, label = car) +
  geom_point(
    color = ifelse(
      d$car != "",
      "red", "grey50"
    )
  ) +
  geom_text_repel()
```
]


.pull-right[
```{r empty, echo=FALSE, fig.height=4, fig.width=4, dpi=200}
set.seed(412)

dat2 <- subset(mtcars, wt > 3 & wt < 4)
# Hide all of the text labels.
dat2$car <- ""
# Let's just label these items.
ix_label <- c(2, 3, 16)
dat2$car[ix_label] <- rownames(dat2)[ix_label]

ggplot(dat2, aes(wt, mpg, label = car)) +
  geom_point(color = ifelse(dat2$car == "", "grey50", "red")) +
  geom_text_repel(force = 3)
```
]

---

# &#x1F393; Learn from examples in the [vignette]

```{r eval=FALSE, tidy=FALSE}
vignette("ggrepel") # <- Run this in RStudio
```

<div class="center">
<img src="index_files/other-examples.png" style="width: 87%;">
</div>

[vignette]: https://cran.r-project.org/web/packages/ggrepel/vignettes/ggrepel.html

---

# &#x1F41B; Please report bugs

### [github.com/slowkow/ggrepel/issues](https://github.com/slowkow/ggrepel/issues)

<br>

.large[
&#x1F381; &nbsp; Contributions are very welcome!

&#x1F64C; &nbsp; We have 8 contributors so far.

&#x2753; &nbsp; [Stackoverflow] is the best place to ask questions.
]

[Stackoverflow]: https://stackoverflow.com/search?q=ggrepel

---

# &#x1F4E6; [ggplot2 extension gallery](http://www.ggplot2-exts.org/gallery/)

<div class="center">
<img src="index_files/ggplot2-extension-gallery.png" alt="" style="width: 72%;">
</div>

---

# &#x1F6E0;&#xFE0F; Make a **ggplot2** extension!

.large[&#x2B50; [Extending ggplot2][ext1]]
  
&nbsp;&nbsp;&nbsp;&nbsp; by [Hadley Wickham]

.large[&#x2B50; [How to make a generic stat in ggplot2][ext3]]
  
&nbsp;&nbsp;&nbsp;&nbsp; by [Elio Campitelli]

.large[&#x1F31F; [ggplot2 Internals][ext4] (WOW!)]

&nbsp;&nbsp;&nbsp;&nbsp; by [Brodie Gaslam]


[ext1]: https://cran.r-project.org/web/packages/ggplot2/vignettes/extending-ggplot2.html
[ext3]: https://eliocamp.github.io/codigo-r/2018/05/how-to-make-a-generic-stat-in-ggplot2/
[ext4]: https://htmlpreview.github.io/?https://github.com/brodieG/ggbg/blob/development/inst/doc/extensions.html

[Hadley Wickham]: http://hadley.nz/
[Elio Campitelli]: https://github.com/eliocamp
[Brodie Gaslam]: http://www.brodieg.com/

---

# &#x1F4DA; Related work

.large[

### Python

- [adjustText](https://github.com/Phlya/adjustText)


### Javascript

- [d3fc-label-layout](https://github.com/d3fc/d3fc-label-layout)

]

---

class: center

.large[
<br><br><br>
These slides are available at:
<br>
### [slowkow.com/ggrepel](https://slowkow.com/ggrepel)
]

<br><br>
<br><br>
Made with &#x2694; [xaringan]

[xaringan]: https://github.com/yihui/xaringan
